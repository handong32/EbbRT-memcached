//          Copyright Boston University SESA Group 2013 - 2014.
// Distributed under the Boost Software License, Version 1.0.
//    (See accompanying file LICENSE_1_0.txt or copy at
//          http://www.boost.org/LICENSE_1_0.txt)
//
#include <cstdlib>
#include <sstream>
#include <string>
#include <ebbrt/SharedIOBufRef.h>
#include <ebbrt/UniqueIOBuf.h>
#include <ebbrt/native/Net.h>
#include <ebbrt/native/Msr.h>

#include "UdpCommand.h"

#define IA32_MISC_ENABLE 0x1A0
#define IA32_PERF_STATUS 0x198
#define IA32_PERF_CTL    0x199

ebbrt::UdpCommand::UdpCommand() {}

void ebbrt::UdpCommand::Start(uint16_t port) {
  udp_pcb.Bind(port);
  udp_pcb.Receive([this](Ipv4Address from_addr, uint16_t from_port,
			 std::unique_ptr<MutIOBuf> buf) {
		    ReceiveCommand(from_addr, from_port, std::move(buf));
		  });
  uint32_t mcore = static_cast<uint32_t>(Cpu::GetMine());
  ebbrt::kprintf_force("Core: %u %s\n", mcore, __PRETTY_FUNCTION__);
}

void ebbrt::UdpCommand::ReceiveCommand(
    Ipv4Address from_addr, uint16_t from_port, std::unique_ptr<MutIOBuf> buf) {
  //uint32_t mcore = static_cast<uint32_t>(Cpu::GetMine());
  std::string s(reinterpret_cast<const char*>(buf->Data()));
  std::string delimiter = ",";
  uint32_t pos = 0, param = 0;
  std::string token1, token2;

  pos = s.find(delimiter);
  token1 = s.substr(0, pos);
  token2 = s.substr(pos+1, s.length());
  param = static_cast<uint32_t>(atoi(token2.c_str()));

  if(token1 == "cpu_config_read") {
    for (uint32_t i = 0; i < static_cast<uint32_t>(Cpu::Count()); i++) {
      event_manager->SpawnRemote(
	[this, i] () mutable {	  
	  auto tmp1 = ebbrt::msr::Read(IA32_MISC_ENABLE);
	  ebbrt::kprintf_force("Core %u: IA32_MISC_ENABLE 0x%llX\n", i, tmp1);

	  auto tmp2 = ebbrt::msr::Read(IA32_PERF_STATUS);
	  ebbrt::kprintf_force("Core %u: IA32_PERF_STATUS 0x%llX\n", i, tmp2);

	  auto tmp3 = ebbrt::msr::Read(IA32_PERF_CTL);
	  ebbrt::kprintf_force("Core %u: IA32_PERF_CTL 0x%llX\n", i, tmp3);
	  
	}, i);
    }
  } else {
    for (uint32_t i = 0; i < static_cast<uint32_t>(Cpu::Count()); i++) {
      event_manager->SpawnRemote(
	[this, token1, param, i] () mutable {
	  ebbrt::kprintf_force("SpawnRemote %u\n", i);
	  network_manager->Config(token1, param);
	}, i);
    }
  }
  //ebbrt::kprintf_force("Core: %u ReceiveCommand() from_port=%u message:%s\n", mcore, from_port, s.c_str());
}
